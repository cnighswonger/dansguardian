<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<html>
	<head>
		<title>DansGuardian 2.9 FAQ</title>
	</head>
	<body>
		<h1>Contents</h1>
		<ol id="top">
			<li><a href="#q1">Do I have to use Squid? Can other software be used as the parent proxy?</a></li>
			<li><a href="#q2">How do I set up virus scanning?</a></li>
			<li><a href="#q3">Can the clamdscan plugin use a remote instance of ClamD?</a></li>
			<li><a href="#q4">Why do downloads take a long time to start when using virus scanning?</a></li>
			<li><a href="#q5">Is there any way to send partial files to clients whilst a file is being virus scanned? DGAV does this and I miss it.</a></li>
			<li><a href="#q6">There appear to be 3 content scanning plugins that invoke ClamAV (&quot;clamdscan&quot;, &quot;clamav&quot; and &quot;commandlinescan&quot;). What is the difference, and which should I be using?</a></li>
			<li><a href="#q7">How do I know whether or not something was virus scanned? OR: I have my AV software set to ignore some file types, but DG is claiming the files have been scanned.</a></li>
			<li><a href="#q8">How do I set up multiple filter groups?</a></li>
			<li><a href="#q9">How do I assign users to groups when using the &quot;ip&quot; auth plugin?</a></li>
			<li><a href="#q10">I cannot use the exceptionuserlist and banneduserlist any more. What happened?</a></li>
			<li><a href="#q11">Looking in Squid's access.log, all entries have the client IP given as the box running DansGuardian (typically 127.0.0.1). How can I log the original client IPs?</a></li>
			<li><a href="#q12">I used to use a &quot;sandwich&quot; configuration (Squid -&gt; DG -&gt; Squid) to implement NTLM support; how do I migrate to DG's native NTLM support?</a></li>
			<li><a href="#q13">How can I disable persistent connections? Will this break NTLM?</a></li>
			<li><a href="#q14">Can users be a member of more than one filter group?</a></li>
			<li><a href="#q15">How does DansGuardian verify passwords? Or: why am I getting authentication prompts with no authplugins enabled?</a></li>
			<li><a href="#q16">Is it possible to disable content filtering, and perform AV scanning only?</a></li>
			<li><a href="#q17">Can I use DG as a pure URL filter?</a></li>
			<li><a href="#q18">How does DG identify adverts?</a></li>
			<li><a href="#q19">Why is the HTML block page not shown when blocking adverts?</a></li>
			<li><a href="#q20">How can I embed images into the HTML template?</a></li>
			<li><a href="#q21">How do I use reportinglevel 2?</a></li>
			<li><a href="#q22">How can I set up time-limited exceptions, e.g. allow webmail access during lunchtime?</a></li>
			<li><a href="#q23">Why don't I see HTTPS requests in DG's access log?</a></li>
			<li><a href="#q24">Why don't I get the full HTML template when an HTTPS request is blocked? Can I customise the message returned?</a></li>
			<li><a href="#q25">Help! I have DansGuardian installed on my gateway, and strangers are using my proxy/filter. How do I stop them?</a></li>
			<li><a href="#q26">DG seems to be very slow to access a site initially, but repeated accesses to the same site are fine. What's going on?</a></li>
			<li><a href="#q27">What permissions does DG need to create its PID file, access.log file and IPC sockets?</a></li>
			<li><a href="#q28">I want to stop people from using MSN, ban filesharing, virus-scan their FTP transfers, put quotas on their email usage, remove all spyware and implement world peace!</a></li>
		</ol>
		<h1>FAQ</h1>
		<p id="q1" style="margin-top: 2em;"><a href="#top">^</a> <strong>1.</strong> <em>Do I have to use Squid? Can other software be used as the parent proxy?</em></p>
		<p>In theory you can use any old HTTP proxy, however DG is only regularly tested with Squid.</p>
		<p id="q2" style="margin-top: 2em;"><a href="#top">^</a> <strong>2.</strong> <em>How do I set up virus scanning?</em></p>
		<p>Make sure DG is built with at least one content scanning plugin enabled (&quot;--enable-clamd&quot;, &quot;--enable-kavd&quot;, &quot;--enable-icap&quot;, &quot;--enable-commandline&quot; or &quot;--enable-clamav&quot;). After compilation and installation, uncomment the relevant &quot;contentscanner&quot; line in dansguardian.conf to enable loading the plugin. Also take a look in the plugin's own configuration file, the path of which is in the &quot;contentscanner&quot; option, and perform any necessary customisations - for example, settings the &quot;clamdudsfile&quot; option in clamdscan.conf.</p><p>	For new installations, the &quot;clamdscan&quot; plugin is recommended; this requires you to have ClamD running on the same machine as DG, but is flexible (using ClamD's own configuration file for extra control) and simple to set up.</p>
		<p id="q3" style="margin-top: 2em;"><a href="#top">^</a> <strong>3.</strong> <em>Can the clamdscan plugin use a remote instance of ClamD?</em></p>
		<p>Not currently, no. The primary reason for this limitation is that by restricting it to local instances only, content does not have to be sent over the network for scanning. This could be achieved with the current version either by hooking up ClamD to an ICAP server and using DG's ICAP plugin. (Another potential method, which hasn't been tested, might be putting DG's filecachedir on NFS and using something like socat (http://www.dest-unreach.org/socat/) to mirror a remote ClamD's UNIX socket.)</p>
		<p id="q4" style="margin-top: 2em;"><a href="#top">^</a> <strong>4.</strong> <em>Why do downloads take a long time to start when using virus scanning?</em></p>
		<p>Because DG has to download the whole file and perform scanning before it can be sent on to the client. Keep-alive data is sent to clients during this process by &quot;download manager&quot; plugins: &quot;default&quot; simply sends dummy HTTP headers, whilst &quot;fancy&quot; sends a full-blown HTML/JavaScript download progress bar (see the included DownloadManagers document for more info on how a manager is chosen for a given transfer).</p>
		<p id="q5" style="margin-top: 2em;"><a href="#top">^</a> <strong>5.</strong> <em>Is there any way to send partial files to clients whilst a file is being virus scanned? DGAV does this and I miss it.</em></p>
		<p>If you have HTTP clients that don't work even with the &quot;default&quot; download manager, or really, really want to give end users the impression that files are downloading, then build and enable the &quot;trickle&quot; plugin. This slowly sends parts of not-yet-scanned files to clients, which enables them to report download progress (although reported progress will be slower than the actual download), and only lets the transfer complete for clean files. Note that there is some debate as whether or not this is entirely safe, as some malware is incredibly small, and some files can be processed before they are completely downloaded, e.g. progressive JPEGs. This explains the decision not to enable this mode by default.</p>
		<p id="q6" style="margin-top: 2em;"><a href="#top">^</a> <strong>6.</strong> <em>There appear to be 3 content scanning plugins that invoke ClamAV (&quot;clamdscan&quot;, &quot;clamav&quot; and &quot;commandlinescan&quot;). What is the difference, and which should I be using?</em></p>
		<p>The &quot;clamdscan&quot; scanner saves all content to disk, and passes filenames to an instance of ClamD. By contrast, the &quot;clamav&quot; scanner actually links with the ClamAV libraries directly, and can scan content having either saved it to file, or to POSIX shared memory (direct scanning of memory buffers has been removed, as the functionality is problematic and considered deprecated by the ClamAV team).</p><p>	The recommended plugin is &quot;clamdscan&quot;, as &quot;clamav&quot; does not provide any control over the options passed to the ClamAV libraries, and will not detect updates to virus signature files. Provided you have somewhere to run ClamD, DG can access ClamD's UNIX socket, and ClamD can access DG's &quot;filecachedir&quot;, there is no reason not to use it.</p><p>	&quot;commandlinescan&quot; should not be used to invoke ClamAV - it *will* be slower than the other two plugins. The default configuration file is purely intended as an example.</p>
		<p id="q7" style="margin-top: 2em;"><a href="#top">^</a> <strong>7.</strong> <em>How do I know whether or not something was virus scanned? OR: I have my AV software set to ignore some file types, but DG is claiming the files have been scanned.</em></p>
		<p>Any content that has been scanned is marked with &quot;*SCANNED*&quot; in DG's access log. Technically, this means it was sent to the loaded content scanning plugins; what these and any external software they may rely on actually did with it is entirely their business. For example, an ICAP server may be configured not to virus scan JPEGs, but unless DG itself is configured similarly, it will send them to it all the same, and log that it has done so.</p>
		<p id="q8" style="margin-top: 2em;"><a href="#top">^</a> <strong>8.</strong> <em>How do I set up multiple filter groups?</em></p>
		<p>Duplicate the dansguardianf1.conf file, so that there is one per group (dansguardianf2.conf, dansguardianf3.conf, etc.). Set the &quot;filtergroups&quot; parameter in dansguardian.conf accordingly. Duplicate the list files referenced by the filter group config - &quot;bannedsitelist&quot;, &quot;bannedurllist&quot; etc. - once per group, if you wish to customise them separately. (These are the &quot;top-level&quot; list files, in that they mostly consist of include statements for other lists.)</p><p>	Uncomment one of the &quot;authplugin&quot; lines in dansguardian.conf and, if choosing proxy-basic or proxy-ntlm, configure Squid to require basic or NTLM authentication accordingly. Fill in the username/group mappings in the &quot;filtergroupslist&quot; file. If you wish to enforce authentication, map all users to groups higher than 1, and set group 1's groupmode to 0 (banned), as this is the default group for unidentified users.</p>
		<p id="q9" style="margin-top: 2em;"><a href="#top">^</a> <strong>9.</strong> <em>How do I assign users to groups when using the &quot;ip&quot; auth plugin?</em></p>
		<p>Use the &quot;/etc/dansguardian/lists/authplugins/ipgroups&quot; file. This is separate from the filtergroupslist because it has a different syntax, catering for IP range and subnet matches instead of static usernames, and is only used by the one plugin.</p>
		<p id="q10" style="margin-top: 2em;"><a href="#top">^</a> <strong>10.</strong> <em>I cannot use the exceptionuserlist and banneduserlist any more. What happened?</em></p>
		<p>These lists were abandoned when the &quot;groupmode&quot; parameter was added to the filter group configuration (dansguardianf*.conf). Banned and exception IP lists still exist, but they are intended for identifying particular machines, not people, and primarily for temporary use only - for example, quickly banning access from a spyware-infested machine, or providing unfiltered access for servers needing to download updates. If you want full identification by IP, use the &quot;ip&quot; auth plugin and multiple filter groups.</p>
		<p id="q11" style="margin-top: 2em;"><a href="#top">^</a> <strong>11.</strong> <em>Looking in Squid's access.log, all entries have the client IP given as the box running DansGuardian (typically 127.0.0.1). How can I log the original client IPs?</em></p>
		<p>Turn on the &quot;forwardedfor&quot; option in dansguardian.conf, and get Squid to obey the &quot;X-Forwarded-For&quot; header in incoming requests. For Squid 2.5, you will have to apply the following patch: http://devel.squid-cache.org/follow_xff/follow_xff-2.5.patch</p><p>	This has become a core feature in Squid 2.6-STABLE1 and above. Be wary of also enabling the &quot;usexforwardedfor&quot; option in DG, as it is trivial for clients to spoof headers in the original request.</p>
		<p id="q12" style="margin-top: 2em;"><a href="#top">^</a> <strong>12.</strong> <em>I used to use a &quot;sandwich&quot; configuration (Squid -&gt; DG -&gt; Squid) to implement NTLM support; how do I migrate to DG's native NTLM support?</em></p>
		<p>Disable the first Squid entirely, and configure the second Squid for NTLM instead of &quot;basic&quot; authentication. Make sure you configure your DG build with &quot;--enable-ntlm&quot; (enabled by default), and uncomment the &quot;authplugin&quot; line in dansguardian.conf corresponding to the &quot;proxy-ntlm&quot; plugin.</p>
		<p id="q13" style="margin-top: 2em;"><a href="#top">^</a> <strong>13.</strong> <em>How can I disable persistent connections? Will this break NTLM?</em></p>
		<p>Disable &quot;client_persistent_connections&quot; in Squid to prevent clients making a persistent connection to the proxy. DansGuardian itself has no related configuration options, as it simply follows the relevant RFCs as best it can, obeying the instructions in the request and response headers (i.e. if Squid disallows persistency, so does DG). This won't break NTLM: it is true that NTLM-over-HTTP requires persistent connections, but Squid always allows persistency during the auth handshake. You can also disable &quot;server_persistent_connections&quot; if you don't want Squid to make persistent connections to origin servers; these are completely de-coupled from persistent connections to clients.</p>
		<p id="q14" style="margin-top: 2em;"><a href="#top">^</a> <strong>14.</strong> <em>Can users be a member of more than one filter group?</em></p>
		<p>No, they cannot. A filter group in DG is a self-contained set of options, not something that can be stacked. If all you really want is to share customised lists between groups, create them as separate files, and put include statements for them in the top-level lists for all applicable groups.</p>
		<p id="q15" style="margin-top: 2em;"><a href="#top">^</a> <strong>15.</strong> <em>How does DansGuardian verify passwords? Or: why am I getting authentication prompts with no authplugins enabled?</em></p>
		<p>DansGuardian does not verify passwords, and will never initiate an authentication handshake on its own. As per the &quot;basic&quot; auth support in the 2.8 series, DG simply passes authentication requests from Squid to the browser, and sniffs the username from the credentials the browser sends back. It is Squid that supplies the authentication request, and Squid that performs the password checking; it does such a good job that we see no reason to re-invent that particular wheel.</p>
		<p id="q16" style="margin-top: 2em;"><a href="#top">^</a> <strong>16.</strong> <em>Is it possible to disable content filtering, and perform AV scanning only?</em></p>
		<p>Yes! There are two options; the easy way, and the hard way. The hard way consists of turning off the individual filtering options one by one: setting &quot;weightedphrasemode = 0&quot;, blanking the bannedsitelist, etc. The easy way is simply to set &quot;groupmode = 2&quot; in your filter group configuration files (dansguardianf*.conf), and enable &quot;contentscanexceptions&quot; in dansguardian.conf.</p>
		<p id="q17" style="margin-top: 2em;"><a href="#top">^</a> <strong>17.</strong> <em>Can I use DG as a pure URL filter?</em></p>
		<p>Yes, although you will be missing out on a lot. Set the &quot;weightedphrasemode&quot; to 0, comment out any &quot;contentscanner&quot; lines, and truncate the banned/exception MIME type, extension and regexp lists.</p>
		<p id="q18" style="margin-top: 2em;"><a href="#top">^</a> <strong>18.</strong> <em>How does DG identify adverts?</em></p>
		<p>Adverts are identified on the basis of the string &quot;ADs&quot; appearing in the categories under which the site is blocked. For example, a URL list containing '#listcategory &quot;ADs&quot;' will identify its contents as adverts.</p>
		<p id="q19" style="margin-top: 2em;"><a href="#top">^</a> <strong>19.</strong> <em>Why is the HTML block page not shown when blocking adverts?</em></p>
		<p>This is primarily so as not to disrupt the rendering of pages containing adverts in IFRAMEs. Showing the block page in an IFRAME would look just as distracting as the advert itself, and may break page layout.</p>
		<p id="q20" style="margin-top: 2em;"><a href="#top">^</a> <strong>20.</strong> <em>How can I embed images into the HTML template?</em></p>
		<p>If customising the template to include images, you will need to run a webserver on your LAN to host them, and ensure that you use absolute URLs in your image tags. DG is not a webserver; even if you put the images in the same directory as the HTML template, it will not be capable of serving them.</p>
		<p id="q21" style="margin-top: 2em;"><a href="#top">^</a> <strong>21.</strong> <em>How do I use reportinglevel 2?</em></p>
		<p>You need to run a webserver to host your custom block page/script, and configure DG's &quot;accessdeniedaddress&quot; to point at it. You cannot point the &quot;accessdeniedaddress&quot; at the filter IP and port; DG is not a webserver, it is only capable of serving its built-in HTML template.</p>
		<p id="q22" style="margin-top: 2em;"><a href="#top">^</a> <strong>22.</strong> <em>How can I set up time-limited exceptions, e.g. allow webmail access during lunchtime?</em></p>
		<p>Create a new site or URL list containing a &quot;#time:&quot; directive (documentation for this can be found in the default bannedsitelist file). Add an include statement (&quot;.Include&lt;filename&gt;&quot;) for your new list to the top-level banned or exception site/URL list, e.g. exceptionurllist, depending on whether you want to create bans or exceptions. The contents of your new file will only be included in the list at the times specified in the time directive.</p>
		<p id="q23" style="margin-top: 2em;"><a href="#top">^</a> <strong>23.</strong> <em>Why don't I see HTTPS requests in DG's access log?</em></p>
		<p>If you are using transparent/interception proxying, you won't, as HTTPS cannot be proxied in this manner due to the end-to-end encryption. Otherwise, first check to see if such requests are showing up in Squid's log - if not, then again, the requests probably aren't going through the filter. If the requests do show up in Squid's log, check DG's &quot;loglevel&quot; setting. The default is 2, which logs all requests for textual content (i.e. HTML but not images); the MIME type of HTTPS requests is not sent in the clear, and so they are not logged since it is not known whether or not content is text.</p>
		<p id="q24" style="margin-top: 2em;"><a href="#top">^</a> <strong>24.</strong> <em>Why don't I get the full HTML template when an HTTPS request is blocked? Can I customise the message returned?</em></p>
		<p>Because some browsers cannot handle unencrypted error pages of more than a few bytes in response to an HTTPS request. Currently this message can only be customised by modifying source code.</p>
		<p id="q25" style="margin-top: 2em;"><a href="#top">^</a> <strong>25.</strong> <em>Help! I have DansGuardian installed on my gateway, and strangers are using my proxy/filter. How do I stop them?</em></p>
		<p>Use a firewall (iptables) to prevent external connections to DG and Squid's listening ports, and/or configure DG and Squid to listen only on LAN interfaces. In DG, a non-blank &quot;filterip&quot; line causes DG to bind its listening socket to the given IP; multiple &quot;filterip&quot; lines can be given if needed. Squid allows specification of bind IPs in the &quot;http_port&quot; directive.</p><p>	Also note that if you do not have any machines/users on your network which are allowed to bypass the filter, then Squid only needs to be configured to listen on the loopback interface (127.0.0.1).</p>
		<p id="q26" style="margin-top: 2em;"><a href="#top">^</a> <strong>26.</strong> <em>DG seems to be very slow to access a site initially, but repeated accesses to the same site are fine. What's going on?</em></p>
		<p>You quite possibly have DNS performance issues. Enable the cache manager in Squid and monitor the average time for DNS requests; ideally values should be in the low single figures. One possibility for reducing DNS load is disabling the &quot;reverseaddresslookups&quot; option in DG; however, people will be able to bypass the site/URL filtering (but not the content or virus filtering) by visiting websites by IP directly.</p>
		<p id="q27" style="margin-top: 2em;"><a href="#top">^</a> <strong>27.</strong> <em>What permissions does DG need to create its PID file, access.log file and IPC sockets?</em></p>
		<p>DG creates and updates its PID file as root, so permissions should not be an issue here. However, it must be able to write to its access.log file as an unprivileged user: this is the user/group set by the &quot;daemonuser&quot; and &quot;daemongroup&quot; options; by default, &quot;nobody:nobody&quot;. The IPC sockets (UNIX domain sockets) must be in a location writable by the unprivileged user; by default they are in &quot;/tmp&quot; and so not generally an issue.</p>
		<p id="q28" style="margin-top: 2em;"><a href="#top">^</a> <strong>28.</strong> <em>I want to stop people from using MSN, ban filesharing, virus-scan their FTP transfers, put quotas on their email usage, remove all spyware and implement world peace!</em></p>
		<p>DansGuardian is an HTTP proxy. It does not speak any other protocol. FTP via HTTP proxy only works because Squid is capable of translating between the two; if you want to use DG as a &quot;real&quot; FTP proxy, for clients other than web browsers, it will not work. It is true that some IM clients can tunnel conversations over HTTP - DG doesn't implement any special features to detect or block this, but incoming messages may be content filtered if they are in the clear, and usage of such clients blocked based on the destination IPs/domains in the HTTP requests.</p>
	</body>
</html>
